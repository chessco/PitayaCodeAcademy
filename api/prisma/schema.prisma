generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// --- TENANCY ---

model Tenant {
  id          String             @id @default(uuid())
  slug        String             @unique // Subdomain
  name        String
  accentColor String?            @default("#3b82f6")
  logoUrl     String?
  users       TenantMembership[]
  courses     Course[]
  coupons     Coupon[]
  orders    Order[]
  reviews   Review[]
  notifications Notification[]
  createdAt DateTime           @default(now())
  updatedAt DateTime           @updatedAt
}

// --- USERS & ROLES ---

model User {
  id           String             @id @default(uuid())
  email        String             @unique
  name         String?
  passwordHash String
  globalRole   GlobalRole         @default(USER) // SUPERADMIN vs USER
  memberships  TenantMembership[]
  createdAt    DateTime           @default(now())
}

model TenantMembership {
  id       String     @id @default(uuid())
  userId   String
  tenantId String
  role     TenantRole // ADMIN, INSTRUCTOR, STUDENT
  
  // Profile Fields
  bio         String?   @db.Text
  avatarUrl   String?
  jobTitle    String?   @default("Estudiante")
  socialGithub   String?
  socialLinkedin String?
  socialTwitter  String?
  interests      String?   @db.Text // JSON list of strings
  
  // Gamification
  xp    Int @default(0)
  level Int @default(1)
  
  // Verification
  isEmailConfirmed   Boolean @default(false)
  isIdentityVerified Boolean @default(false)

  user     User       @relation(fields: [userId], references: [id])
  tenant   Tenant     @relation(fields: [tenantId], references: [id])

  instructorCourses Course[]     @relation("CourseInstructor")
  enrollments       Enrollment[]
  orders            Order[]
  reviews           Review[]
  discussions       DiscussionTopic[]
  discussionPosts   DiscussionPost[]
  notifications     Notification[]

  @@unique([userId, tenantId])
}

enum GlobalRole {
  SUPERADMIN
  USER
}

enum TenantRole {
  ADMIN
  INSTRUCTOR
  STUDENT
}

// --- LMS CORE ---

model Course {
  id           String  @id @default(uuid())
  tenantId     String
  instructorId String
  title        String
  slug         String
  description  String? @db.Text
  price        Decimal @db.Decimal(10, 2)
  category     String?
  level        String?
  thumbnail    String?
  isPublished  Boolean @default(false)

  tenant     Tenant           @relation(fields: [tenantId], references: [id]) // Virtual relation helper if needed, but tenantId is real
  instructor TenantMembership @relation("CourseInstructor", fields: [instructorId], references: [id])
  modules    Module[]
  lessons    Lesson[]
  resources  CourseResource[]

  coupons      Coupon[]     @relation("CouponCourses")
  enrollments  Enrollment[]
  orderItems   OrderItem[]
  reviews      Review[]
  discussions DiscussionTopic[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([tenantId, slug])
}

model Lesson {
  id          String  @id @default(uuid())
  courseId    String
  title       String
  content     String? @db.Text // JSON or HTML
  videoUrl    String?
  sortOrder   Int
  isPublished Boolean @default(true)
  moduleId    String?

  course Course  @relation(fields: [courseId], references: [id])
  module Module? @relation(fields: [moduleId], references: [id])

  resources CourseResource[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model CourseResource {
  id        String   @id @default(uuid())
  courseId  String
  lessonId  String?
  title     String
  url       String
  fileSize  String?
  fileType  String?
  isVisible Boolean  @default(true)

  course    Course   @relation(fields: [courseId], references: [id])
  lesson    Lesson?  @relation(fields: [lessonId], references: [id], onDelete: SetNull)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Module {
  id        String   @id @default(uuid())
  courseId  String
  tenantId  String
  title     String
  sortOrder Int
  course    Course   @relation(fields: [courseId], references: [id])
  lessons   Lesson[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Enrollment {
  id         String     @id @default(uuid())
  courseId   String
  studentId  String
  accessType AccessType @default(LIFETIME)

  course  Course           @relation(fields: [courseId], references: [id])
  student TenantMembership @relation(fields: [studentId], references: [id])

  createdAt DateTime @default(now())

  @@unique([courseId, studentId])
}

enum AccessType {
  LIFETIME
  SUBSCRIPTION
}

// --- E-COMMERCE ---

model Coupon {
  id            String       @id @default(uuid())
  tenantId      String
  code          String
  discountType  DiscountType
  discountValue Decimal
  maxUses       Int?
  usedCount     Int          @default(0)
  startsAt      DateTime?
  expiresAt     DateTime?

  tenant  Tenant   @relation(fields: [tenantId], references: [id])
  courses Course[] @relation("CouponCourses")

  createdAt DateTime @default(now())

  @@unique([tenantId, code])
}

enum DiscountType {
  PERCENTAGE
  FIXED
}

model Order {
  id              String      @id @default(uuid())
  tenantId        String
  studentId       String
  status          OrderStatus @default(PENDING)
  totalAmount     Decimal
  stripeSessionId String?

  tenant  Tenant           @relation(fields: [tenantId], references: [id])
  student TenantMembership @relation(fields: [studentId], references: [id])
  items   OrderItem[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model OrderItem {
  id       String  @id @default(uuid())
  orderId  String
  courseId String
  price    Decimal

  order  Order  @relation(fields: [orderId], references: [id])
  course Course @relation(fields: [courseId], references: [id])
}

model Review {
  id          String   @id @default(uuid())
  tenantId    String
  courseId    String
  studentId   String
  rating      Int
  comment     String?  @db.Text
  pros        String?  @db.Text // Comma separated tags
  contras     String?  @db.Text // Comma separated tags
  
  tenant      Tenant           @relation(fields: [tenantId], references: [id])
  course      Course           @relation(fields: [courseId], references: [id])
  student     TenantMembership @relation(fields: [studentId], references: [id])

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([courseId, studentId])
}

// --- DISCUSSIONS ---

model DiscussionTopic {
  id         String             @id @default(uuid())
  courseId   String
  authorId   String
  title      String
  content    String             @db.Text
  category   DiscussionCategory @default(GENERAL)
  isPinned   Boolean            @default(false)
  isResolved Boolean            @default(false)
  views      Int                @default(0)

  course Course           @relation(fields: [courseId], references: [id])
  author TenantMembership @relation(fields: [authorId], references: [id])
  posts  DiscussionPost[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model DiscussionPost {
  id      String @id @default(uuid())
  topicId String
  authorId String
  content String @db.Text

  topic  DiscussionTopic  @relation(fields: [topicId], references: [id], onDelete: Cascade)
  author TenantMembership @relation(fields: [authorId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

enum DiscussionCategory {
  ANNOUNCEMENT
  QUESTION
  PROPOSAL
  GENERAL
}

// --- NOTIFICATIONS ---

model Notification {
  id          String           @id @default(uuid())
  tenantId    String
  studentId   String
  type        NotificationType @default(SYSTEM)
  title       String
  content     String           @db.Text
  link        String?
  isRead      Boolean          @default(false)

  tenant  Tenant           @relation(fields: [tenantId], references: [id])
  student TenantMembership @relation(fields: [studentId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

enum NotificationType {
  COURSE
  FORUM
  SYSTEM
  ACHIEVEMENT
  PROMOTION
}

enum OrderStatus {
  PENDING
  PAID
  FAILED
  REFUNDED
}


